<!DOCTYPE html>
<html>
<head>
	<title>Image Recognition</title>

	<!-- <link rel="stylesheet" href="static/components/element-ui/index.css"> -->
	<link rel="stylesheet" href="https://unpkg.com/element-ui@2.12.0/lib/theme-chalk/index.css">
</head>
<body>
	
	<div id="app-container">
		<el-row>
			<el-col>
				<div style="text-align: right;margin-bottom: 10px;">
					<el-button 
						type="primary" 
						icon="el-icon-upload" 
						@click="uploadVisible = true">上传</el-button>
					<el-button 
						type="success" 
						icon="el-icon-check" 
						:disabled="disableSave" 
						@click="saveData" 
						v-loading.fullscreen.lock="loading">保存</el-button>
				</div>
			</el-col>
		</el-row>

		<el-row>
			<el-col>
				<div v-for="(md, ind) in metadatas" :key="md.final_name + ind">
					<el-row>
						<el-col :span="3">
							<el-image 
								:src="md.filepath"
								fit="cover"
								lazy
								style="width: 200px; height: 200px"/>
						</el-col>
						<el-col :span="6">
							<el-input v-model="md.probability" clearable placeholder="请输入概率">
								<template slot="prepend">概率</template>
							</el-input>
							<el-select v-model="md.category" placeholder="请选择类别">
								<el-option
									v-for="(it, ind) in categorys"
									:key="it"
									:label="it"
									:value="ind"/>
							</el-select>
						</el-col>
					</el-row>
				</div>
			</el-col>
		</el-row>

		<el-dialog :visible.sync="uploadVisible" title="选择图片">
			<el-upload
				ref="upload"
				action="#"
				list-type="picture-card"
				:multiple="true"
				:auto-upload="false"
				:http-request="appendFile">
				<i class="el-icon-plus"></i>
			</el-upload>
			<span slot="footer" class="dialog-footer">
				<el-button @click="uploadVisible = false">取 消</el-button>
				<el-button type="primary" 
					@click="submitFile" 
					v-loading.fullscreen.lock="loading">确 定</el-button>
			</span>
		</el-dialog>
	</div>

</body>

	<script src="static/components/vue/vue.js"></script>
	<!-- <script src="static/components/element-ui/index.js"></script> -->
	<script src="https://unpkg.com/element-ui@2.12.0/lib/index.js"></script>
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
	<script>
	new Vue({
		el: '#app-container',
		data: function() {
			return {
				categorys: ['W', 'WP', 'P', 'S', 'rubbled'],
				uploadVisible: false,
				loading: false,
				formData: null,
				metadatas: []
			}
		},
		computed: {
			disableSave() {
				return this.metadatas.length === 0
			}
		},
		methods: {
			appendFile(file) {
				this.formData.append('file', file.file);
			},
			submitFile() {
				this.loading = true;

				this.formData = new FormData();
				this.\$refs.upload.submit();

				axios.post('/upload', this.formData, {
					headers: { 'Content-Type': 'multipart/form-data' }
				}).then(({ data = [] }) => {
					console.info(JSON.stringify(data))
					// console.info(res.data)
					// console.info(typeof res.data)
					// console.info(JSON.parse(res.data))
					this.metadatas = data;
					this.uploadVisible = false;
					this.loading = false;
				}).catch(res => {
					console.error('upload error: ' + res);
					this.loading = false;
				});
			},
			saveData() {
				// console.log(JSON.stringify(this.metadatas))
				// let mds = new FormData();
				// mds.append('metadatas', this.metadatas);
				// this.metadatas.forEach(it => {
				// 	mds.append('metadata', it);
				// });
				this.loading = true;
				axios.post('/save', { data: JSON.stringify(this.metadatas) }).then(res => {
					console.info(res)
					this.loading = false;
				}).catch(res => {
					console.error('save error: ' + res);
					this.loading = false;
				});
			}
			// handleRemove(file, fileList) {
			// 	// :on-remove="handleRemove"
			// 	console.log(file, fileList);
			// },
			// handlePictureCardPreview(file) {
			// 	// :on-preview="handlePictureCardPreview"
			// 	this.previewImageUrl = file.url;
			// 	this.previewVisible = true;
			// }
		}
	});
  </script>
</html>
